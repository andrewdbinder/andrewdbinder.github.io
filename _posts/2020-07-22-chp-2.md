---
title: Test Post
layout: post
date: 2020-08-21
description: Creating a system to emulate the emergency lighting patterns of the California Highway Patrol and embedding in a diecast car
image: chp_boards/EOR_5258.JPG
categories: ["CHP"]
published: false
---


This is a display board used for emulating and displaying the emergency lighting patterns the California Highway Patrol uses on their patrol vehicles. Having built similar projects previously, this version allowed for many improvements. Some constraints from previous editions were changed or removed, allowing for some impressive aesthetic and technical improvements.

## System Overview

Keeping in mind goals and previous constraints, I came up with a list of goals for this version of the project.

- Accurate Flash Pattern Emulation
- Siren Sound Effects
- Keypad Compatibility
- Custom Microcontroller


I had some issues with the previous version of this project I made. I made a PCB that an Arduino Nano plugged into, with connections for power and data lines for the MAX7219 I used to drive LED's. While available on DigiKey, this part cost about $7 a piece for low quantities I used (I found it cheaper to "kit bash" matrix kits from Amazon). So, I used one chip to drive all of the different display boards I made. I ended up using RJ45 connectors to output the rows and columns of the LED driver to separate daughterboards with the actual LED's on them.

The display boards were 100mm x 100mm (the largest size the PCB manufacturer I used accepted at low costs), and filled with through-hole LED's. They also had matching RJ45 connectors to connect to the microcontroller board.

Ultimately, I didn't like the MAX7219/Arduino combination for this application. I did get it working (flawlessly, I might add), but there were a few things that bothered me.

The MAX7219 is a constant voltage matrix driver, which brings a couple of challenges. The constant voltage means I needed to pick one voltage which ran all of the LED's, and I was using red LED's (Vf = 1.7 V), white LED's (Vf = 3.2 V), and everything in between. This meant that the red LED's were being over-driven while blue/white LED's were being under-driven. The other major problem I had with this setup was since the LED's were connected as a matrix, I didn't get individual control of the brightness of each LED, which meant on/off values only. This approach wasn't great for simulating incandescent bulbs.

The Arduino Nano I used worked great, but there were still some problems. I was limited in the I/O available. One UART on the board made controlling the lights and siren problematic. The UART is already shared between the USB and I/O pins, which meant I couldn't use it to control flash patterns from a computer and a separate UART-controller sound effects board. The libraries I was using to control the MAX7219 also bothered me. SPI was implemented fully in software by toggling outputs high/low as needed, which after seeing the capabilities of other microcontrollers bothered me more.

Speaking of sound effects, I found Adafruit made an all-in-one audio storage/decoder/DAC/amplifier, and got it hacked together to work with what I had. I had to control it with one of the Arduino Mega's UART connections, which was available on the keypad I made, instead of the Arduino Nano controlling the actual lights. With the firmware I wrote, it was tough to keep the keypad and display in sync regarding patterns and what sounds should be output when.

## Microcontroller Board

During spring quarter of my senior year of college, I was introduced to the STM32 lineup when we used an STM32F4 Discovery board in Embedded Programming class. I was really impressed with the capabilities of the STM32 MCU's, especially considering I was used to the relatively simple AVR chips used in Arduinos. For example, the STM32F407VG used in the Discovery board has 6 separate hardware UART's available, which really impressed me.

About halfway through this class, after learning how powerful these chips are, I learned how popular they were for DIY-style embedded projects. This made me want to make a PCB with one of these chips on it for my CHP project. After lots of research and design work, I came up with a 4-layer microcontroller board for an STM32G4.

<img class="card-img" src="/img/chp_boards/controller.png" alt="">

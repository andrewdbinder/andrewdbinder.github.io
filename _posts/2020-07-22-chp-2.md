---
title: Test Post
layout: post
date: 2020-08-21
description: Creating a system to emulate the emergency lighting patterns of the California Highway Patrol and embedding in a diecast car
image: chp_boards/EOR_5258.JPG
categories: ["CHP"]
published: true
---


This is a display board used for emulating and displaying the emergency lighting patterns the California Highway Patrol uses on their patrol vehicles. Having built similar projects previously, this version allowed for many improvements. Some constraints from previous editions were changed or removed, allowing for some impressive aesthetic and technical improvements.

## System Overview

Keeping in mind goals and previous constraints, I came up with a list of goals for this version of the project.

- Accurate Flash Pattern Emulation
- Siren Sound Effects
- Keypad Compatibility
- Custom Microcontroller


I had some issues with the previous version of this project I made. I made a PCB that an Arduino Nano plugged into, with connections for power and data lines for the MAX7219 I used to drive LED's. While available on DigiKey, this part cost about $7 a piece for low quantities I used (I found it cheaper to "kit bash" matrix kits from Amazon). So, I used one chip to drive all of the different display boards I made. I ended up using RJ45 connectors to output the rows and columns of the LED driver to separate daughterboards with the actual LED's on them.

The display boards were 100mm x 100mm (the largest size the PCB manufacturer I used accepted at low costs), and filled with through-hole LED's. They also had matching RJ45 connectors to connect to the microcontroller board.

### The Old Version's Controller

Ultimately, I didn't like the MAX7219/Arduino combination for this application. I did get it working (flawlessly, I might add), but there were a few things that bothered me.

The MAX7219 is a constant voltage matrix driver, which brings a couple of challenges. The constant voltage means I needed to pick one voltage which ran all of the LED's, and I was using red LED's (Vf = 1.7 V), white LED's (Vf = 3.2 V), and everything in between. This meant that the red LED's were being over-driven while blue/white LED's were being under-driven. The other major problem I had with this setup was since the LED's were connected as a matrix, I didn't get individual control of the brightness of each LED, which meant on/off values only. This approach wasn't great for simulating incandescent bulbs.

The Arduino Nano I used worked great, but there were still some problems. I was limited in the I/O available. One UART on the board made controlling the lights and siren problematic. The UART is already shared between the USB and I/O pins, which meant I couldn't use it to control flash patterns from a computer and a separate UART-controller sound effects board. The libraries I was using to control the MAX7219 also bothered me. SPI was implemented fully in software by toggling outputs high/low as needed, which after seeing the capabilities of other microcontrollers bothered me more.

Speaking of sound effects, I found Adafruit made an all-in-one audio storage/decoder/DAC/amplifier, and got it hacked together to work with what I had. I had to control it with one of the Arduino Mega's UART connections, which was available on the keypad I made, instead of the Arduino Nano controlling the actual lights. With the firmware I wrote, it was tough to keep the keypad and display in sync regarding patterns and what sounds should be output when.

### The Old Version's Display Boards

The PCB's with LED's and silkscreen to look like cars were great. I made them in Fritzing using an autorouter. They were limited to 100mm x 100mm, because Seeed Studio's Fusion PCB service was cheap, up to that size. Anything larger than that was inhibitively expensive. Once put next to each other (front and back), the RJ45 connectors ended up being slightly too far from each other to comfortably reach the control board with the Arduino and LED driver.

## Microcontroller Board

During spring quarter of my senior year of college, I was introduced to the STM32 lineup when we used an STM32F4 Discovery board in Embedded Programming class. I was really impressed with the capabilities of the STM32 MCU's, especially considering I was used to the relatively simple AVR chips used in Arduinos. For example, the STM32F407VG used in the Discovery board has 6 separate hardware UART's available, which really impressed me.

About halfway through this class, after learning how powerful these chips are, I learned how popular they were for DIY-style embedded projects. This made me want to make a PCB with one of these chips on it for my CHP project. After lots of research and design work, I came up with a 4-layer microcontroller board for an STM32G4.

<img class="card-img" src="/img/chp_boards/controller.png" alt="">

I chose an STM32G4 because it was one of the newest chips available in the STM32 lineup, and it had one of the smallest footprints (compared to the STM32F4, which I wanted to stick to something similar). The connectivity and available peripherals seemed right for the size, too. I determined I needed two UART's, SPI, a handful of timers, and USB.

## Display Boards

After learning of JLCPCB and their reasonable prices for boards over 100mm x 100mm, I became really excited for a new version of these PCB's. Instead of two boards, one for the front and one for the back, I could just make one board that the microcontroller could plug in to. I also wanted to build these with surface-mount components, as I think they have a much cleaner look, especially when comparing LED's.

After plugging in and unplugged these RJ45 cables into all of the different display boards I had made over a year or two, I decided I hated them. I only used them because I was taking all of the LED pins to another board, which I decided that wasn't the best way to do it.

After some research, I found the TLC5947 by Texas Instruments. It is a 24-channel constant current LED driver with built-in PWM and run by SPI daisy chaining. At $5 a piece, they are still fairly spendy, but I was much more willing to pay for these than the MAX7219, due to the functionality they provide.

After choosing the chip, I got to work taking my line-art vehicles and designing the PCB's. I went with a size of 180mm x 100mm. I kept all data lines on the top layer and the LED connections on the bottom layer, which made layout very simple.

<img class="card-img" src="/img/chp_boards/tahoe.png" alt="">
<img class="card-img" src="/img/chp_boards/pcfcharger.png" alt="">

I ended up ordering two boards, one with Chevy Tahoe art and one with the newest creation to come out of CHP's Fleet Ops, the 2019 PCF Charger, which is unique because it doesn't have a pushbar. This selection would allow me to test all of the functionality I needed to implement, including DRL wig-wags and high-beam incandescent headlight flashing.
